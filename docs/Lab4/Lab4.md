# Lab4

<!-- !!! danger "实验并未 release，内容随时都会变化。个人水平有限，如您发现文档中的疏漏欢迎 Issue！" -->

<!-- !!! tip "**2023.4.5** 更新：。注意本附件并未经过验证，如果你发现错误，请与我联系修改，谢谢！" -->

本次实验需要完成单周期 CPU，实现 RISC-V 32I 指令集的所有指令，如果你对指令不熟悉，可以查看 RISC-V 手册或[速查表](../Other/RISC_V.md)。

我们会在 Lab2 的工程上进行修改。回顾 Lab2 中我们使用了一个 SCPU IP 核来执行指令，而 Lab4 我们需要将自己实现 SCPU 的嵌入到 Lab2 的工程中。具体来说，你需要实现一个 SCPU 模块，作用是连接 CtrlUnit 模块和 DataPath 模块。随后将给出的 CtrlUnit 和 DataPath IP 核替换为你自己设计的 CtrlUnit 和 DataPath 模块。

实验分为四个小实验：

* Lab4-1：使用提供的 DataPath 和 CtrlUnit 的 IP 核组成 SCPU。
* Lab4-2：自行实现 CtrlUnit 与 DataPath 并组成 SCPU。（此时的 SCPU 只能支持部分指令）
* Lab4-3：在之前实验的基础上拓展以实现 RISC-V 32I 中的所有指令（除 `ecall, ebreak`）。
* Lab4-4：在 Lab4-3 的基础上实现中断处理。

对于 Lab4-1 至 Lab4-3，你可以以**任意顺序**完成属于你自己的 SCPU，并支持我们在 Lab4-3 里要求的指令。如果你对自己的能力有信心，我们推荐你以自己的方式完成实验，而不是根据我们所给出的实验顺序。对于这样完成的同学，你只需要完成 Lab4-3 中的仿真要求和下板验证要求，通过 Lab4-3 的验收，并完成 Lab4-3 的报告即可，不需要再完成 Lab4-1 和 Lab4-2。

对于按照 Lab4-1、Lab4-2、Lab4-3 的顺序完成实验的同学，你需要完成 Lab4-1、Lab4-2、Lab4-3 的仿真验证和下板验证，并完成每个实验的报告。如果你最后的 SCPU 无法通过 Lab4-3 的验收，你可以选择验收部分实验来获得部分分数。

!!! Tip
    * 你可能需要头文件来方便代码的书写或提高可读性，你可以参考附件 [Lab4_header.vh](./attachment/Lab4_header.vh).
    * 完成小实验后（如 Lab4-1），**请做好工程备份**（可以拷贝一份工程目录，或者使用 git 记录）。
    * 这里我们不推荐将 DataPath/CtrlUnit/SCPU 等你可能会频繁修改的模块封装为 IP 核使用，直接添加并引用源文件即可。
    * 如果你对实验的内容一头雾水，请先回顾理论课中控制单元和数据通路的相关部分。良好的理论基础是实验顺利的前提。

!!! warning "本实验需要提交实验报告（Lab4 的四个小实验合成一份提交）"

!!! warning "本实验需要验收"